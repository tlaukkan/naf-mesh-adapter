!function(e){var n={};function t(s){if(n[s])return n[s].exports;var i=n[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,t),i.l=!0,i.exports}t.m=e,t.c=n,t.d=function(e,n,s){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:s})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(t.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var i in e)t.d(s,i,function(n){return e[n]}.bind(null,i));return s},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=4)}([function(e,n,t){"use strict";function s(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}n.HandshakeRequest=function(){return function e(n,t){s(this,e),this.typeName="HandshakeRequest",this.email=n,this.secret=t}}(),n.HandshakeResponse=function(){return function e(n,t){s(this,e),this.typeName="HandshakeResponse",this.id=n,this.error=t}}(),n.Message=function(){return function e(n,t,i,o){s(this,e),this.typeName="Message",this.sourceId=n,this.targetId=t,this.contentType=i,this.contentJson=o}}()},function(e,n,t){"use strict";var s=t(0),i=s.HandshakeRequest,o=(s.HandshakeResponse,s.Message);n.SignalingClient=function(){return function e(n,t,s){var r=this;!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e);var a=this;this.State={CONNECTING:"CONNECTING",CONNECTION_FAILED:"CONNECTION_FAILED",CONNECTED:"CONNECTED",DISCONNECTED:"DISCONNECTED"},this.id=null,this.email=t,this.state=a.State.DISCONNECTED,this.webSocket=null,this.send=function(e,n,t){if(a.state!=a.State.CONNECTED)throw new Error("signaling client send() called when in state is not connected: "+a.state);if(r.id){var s=JSON.stringify(t);a.webSocket.send(JSON.stringify(new o(r.id,e,n,s)))}},this.disconnect=function(){a.webSocket.close()},this.connect=function(){if(a.state!=a.State.DISCONNECTED&&a.state!=a.State.CONNECTION_FAILED)throw new Error("signaling client connect() called when in state is not disconnected or connection failed: "+a.state);a.state=a.State.CONNECTING,a.webSocket=new WebSocket(n,"webrtc-signaling")},this.onConnected=function(e){},this.onConnectFailed=function(e){},this.onConnectionError=function(){},this.onDisconnect=function(){},this.onReceive=function(e,n,t){},this.connect(),this.webSocket.onerror=function(e){r.id?(a.onConnectionError(e),a.disconnect()):(a.state=a.State.CONNECTION_FAILED,a.onConnectFailed(e))},this.webSocket.onclose=function(){a.state=a.State.DISCONNECTED,a.onDisconnect()},this.webSocket.onopen=function(){a.webSocket.send(JSON.stringify(new i(t,s)))},this.webSocket.onmessage=function(e){if("string"==typeof e.data){var n=JSON.parse(e.data);"HandshakeResponse"===n.typeName&&(n.id?(a.id=n.id,a.state=a.State.CONNECTED,a.onConnected(n.id)):(console.log("signaling client handshake failed: "+n.error),a.disconnect(),a.state=a.State.CONNECTION_FAILED)),"Message"===n.typeName&&a.onReceive(n.sourceId,n.contentType,JSON.parse(n.contentJson))}}}}()},function(e,n,t){"use strict";var s=t(1).SignalingClient;function i(e){return new Promise(function(n){return setTimeout(n,e)})}n.SignalingChannel=function(){return function e(){var n=this;!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e);var t=this;this.ObjectType={OFFER:"OFFER",ANSWER:"ANSWER",ICE_CANDIDATE:"ICE_CANDIDATE"},this.clients=new Map,this.onServerConnectedCallbacks=new Map,this.connections=new Map,this.onOffer=function(e,n,t){throw new Error("onOffer has to be overridden with implementation of returning new RTCPeeringConnection(configuration).")},this.onServerConnected=function(e,n){},this.onServerConnectFailed=function(e,n){},this.onServerDisconnect=function(e){},this.onServerConnectionError=function(e){},this.close=function(){n.clients.forEach(function(e){e.disconnect()})},this.removeConnection=function(e){n.connections.forEach(function(t,s){t===e&&n.connections.delete(s)})},this.removeServer=function(e){t.clients.has(e)&&((t.clients.get(e).state=t.clients.get(e).State.CONNECTED)&&t.clients.get(e).disconnect(),t.clients.delete(e)),t.onServerConnectedCallbacks.has(e)&&t.onServerConnectedCallbacks.delete(e),t.connections.forEach(function(n,s){s.startsWith(e)&&t.connections.delete(s)})},this.addServer=function(e,n,i,o,r){o&&t.onServerConnectedCallbacks.set(e,o);var a=new s(e,n,i);t.clients.set(e,a),a.onConnected=function(n){if(t.onServerConnected(e,n),t.onServerConnectedCallbacks.has(e)){var s=t.onServerConnectedCallbacks.get(e);s&&s(e,n),t.onServerConnectedCallbacks.delete(e)}},a.onConnectFailed=function(n){console.log("Connect failed."),r&&r(n),t.onServerConnectFailed(n,e)},a.onReceive=async function(n,s,i){try{if(s===t.ObjectType.OFFER){var o=t.onOffer(e,n,i);t.connections.set(e+"/"+a.id+"-"+n,o),o.onicecandidate=async function(e){a.send(n,t.ObjectType.ICE_CANDIDATE,e.candidate)},await o.setRemoteDescription(i),await o.setLocalDescription(await o.createAnswer()),a.send(n,t.ObjectType.ANSWER,o.localDescription)}if(s===t.ObjectType.ANSWER){var r=t.connections.get(e+"/"+a.id+"-"+n);await r.setRemoteDescription(i)}s===t.ObjectType.ICE_CANDIDATE&&i&&t.connections.get(e+"/"+a.id+"-"+n).addIceCandidate(i)}catch(e){throw console.log("rtc peer error processing received object "+s+" "+JSON.stringify(i)+":"+e.message),new Error("rtc peer error processing received object "+s+" "+JSON.stringify(i)+":"+e.messag)}},a.onDisconnect=function(){t.onServerDisconnect(e),setTimeout(function(){a.connect()},1e4)},a.onConnectionError=function(){t.onServerConnectionError(e)}},this.offer=async function(e,n,s){try{var i=t.clients.get(e);await t.waitForClientToConnect(i),t.connections.set(e+"/"+i.id+"-"+n,s),s.onicecandidate=async function(e){i.send(n,t.ObjectType.ICE_CANDIDATE,e.candidate)},s.createOffer().then(async function(e){try{await s.setLocalDescription(e),i.send(n,t.ObjectType.OFFER,s.localDescription)}catch(e){console.log(e.message)}})}catch(e){throw console.log("rtc peer error sending offer: "+e.message),new Error("rtc peer error sending offer: "+e.message)}},this.waitForClientToConnect=async function(e){if(!e)throw new Error("Not connected to signaling server.");for(var n=0;e.state!==e.State.CONNECTED;)if(await i(100),++n>50)throw console.log("Waiting for client to connect timed out: "+signalingServerUrl),new Error("Waiting for client to connect timed out: "+signalingServerUrl)}}}()},function(e,n,t){"use strict";var s=function(){return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,n){var t=[],s=!0,i=!1,o=void 0;try{for(var r,a=e[Symbol.iterator]();!(s=(r=a.next()).done)&&(t.push(r.value),!n||t.length!==n);s=!0);}catch(e){i=!0,o=e}finally{try{!s&&a.return&&a.return()}finally{if(i)throw o}}return t}(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i=function(){function e(e,n){for(var t=0;t<n.length;t++){var s=n[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(n,t,s){return t&&e(n.prototype,t),s&&e(n,s),n}}();function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var r=t(2).SignalingChannel,a=function e(n){o(this,e);var t=n.lastIndexOf("/");this.peerUrl=n,this.signalingServerUrl=n.substr(0,t),this.peerId=n.substr(t+1)},c=function e(n,t){o(this,e),this.dataType=n,this.data=t},l=function(){function e(){o(this,e),this.debugLog("--- mesh adapter constructor ---"),this.app="default",this.room="default",this.configuration={iceServers:[{urls:"stun:stun1.l.google.com:19302"}]},this.options=null,this.email=Date.now().toString(),this.secret=Date.now().toString(),this.debugLogPrefix=null,this.signalingServerUrl="wss://tlaukkan-webrtc-signaling.herokuapp.com",this.selfPeerUrl=null,this.serverPeerUrl=null,this.signalingChannelOne=new r,this.selfPeerIds=new Map,this.connections=new Map,this.channels=new Map,this.peers=new Map,"undefined"!=typeof document&&(this.email=document.title,this.secret=document.title,this.debugLogPrefix=document.title),this.debugLog("--- mesh adapter constructor ---")}return i(e,[{key:"setServerUrl",value:function(e){this.debugLog("--- mesh adapter set server url ---"),this.debugLog("set server URL to initial peer URL: "+e),e&&(this.serverPeerUrl=e),this.debugLog("--- mesh adapter set server url ---")}},{key:"setApp",value:function(e){this.debugLog("--- mesh adapter set app name ---"),this.app=e,this.debugLog("--- mesh adapter set app name ---")}},{key:"setRoom",value:function(e){this.debugLog("--- mesh adapter set app name ---"),this.room=e,this.debugLog("--- mesh adapter set app name ---")}},{key:"setWebRtcOptions",value:function(e){this.debugLog("--- mesh adapter set web rtc options ---"),this.options=e,this.debugLog("--- mesh adapter set web rtc options ---")}},{key:"setServerConnectListeners",value:function(e,n){this.debugLog("--- mesh adapter set server connect listener ---"),this.connectSuccess=e,this.connectFailure=n,this.debugLog("--- mesh adapter set server connect listener ---")}},{key:"setRoomOccupantListener",value:function(e){this.debugLog("--- mesh adapter set room occupant listener ---"),this.roomOccupantListener=e,this.debugLog("--- mesh adapter set room occupant listener ---")}},{key:"setDataChannelListeners",value:function(e,n,t){this.debugLog("--- mesh adapter set data channel listeners ---"),this.openListener=e,this.closedListener=n,this.messageListener=t,this.debugLog("--- mesh adapter set data channel listeners ---")}},{key:"connect",value:function(){var e=this,n=this;this.debugLog("--- mesh adapter connect ---"),this.signalingChannelOne.addServer(this.signalingServerUrl,this.email,this.secret,async function(t,s){n.selfPeerUrl=t+"/"+s,n.serverPeerUrl&&n.serverPeerUrl.length>3?(await n.offer(new a(n.serverPeerUrl),s),n.connectSuccess(n.selfPeerUrl)):(e.debugLog("mesh adapter did not send offer as initialPeerUrl was not set via setServerUrl function."),n.connectSuccess(n.selfPeerUrl))},function(){n.connectFailure()}),this.signalingChannelOne.onServerConnected=async function(t,s){n.selfPeerIds.set(t,s),e.debugLog("mesh adapter connected to signaling server "+t+"/"+s)},this.signalingChannelOne.onOffer=function(e,t,s){return n.acceptOffer(e,t,s)},this.debugLog("--- mesh adapter connect ---")}},{key:"disconnect",value:function(){self=this,this.channels.forEach(function(e,n){self.closeStreamConnection(n)}),this.signalingChannelOne.close()}},{key:"shouldStartConnectionTo",value:function(e){return this.debugLog("--- mesh adapter should start connection to ---"),this.debugLog("--- mesh adapter should start connection to ---"),!this.connections.has(e)}},{key:"startStreamConnection",value:function(e){var n=this;this.debugLog("--- mesh adapter start stream connection ---");var t=new a(e);if(n.selfPeerIds.has(t.signalingServerUrl)){var s=n.selfPeerIds.get(t.signalingServerUrl),i=t.signalingServerUrl+"/"+s;n.sendOffer(t,i)}else n.signalingChannelOne.addServer(t.signalingServerUrl,this.email,this.secret,async function(e,s){n.sendOffer(t,e+"/"+s)});this.debugLog("--- mesh adapter start stream connection ---")}},{key:"closeStreamConnection",value:function(e){if(this.debugLog("--- mesh adapter close stream connection ---"),this.channels.has(e)){var n=this.channels.get(e);n.close(),this.channels.delete(n),this.debugLog("mesh adapter removed channel"+e)}if(this.connections.has(e)){var t=this.connections.get(e);this.signalingChannelOne.removeConnection(t),t.close(),this.connections.delete(e),this.debugLog("mesh adapter removed connection"+e)}this.closedListener(e),this.debugLog("--- mesh adapter close stream connection ---")}},{key:"getConnectStatus",value:function(e){return this.debugLog("--- mesh adapter get connect status ---"),this.channels.has(e)?(this.debugLog("--- mesh adapter get connect status ---"),"IS_CONNECTED"):(this.debugLog("--- mesh adapter get connect status ---"),"NOT_CONNECTED")}},{key:"sendData",value:function(e,n,t){this.debugLog("--- mesh adapter send data ---"),this.channels.has(e)&&this.channels.get(e).send(JSON.stringify(new c(n,t))),this.debugLog("--- mesh adapter send data ---")}},{key:"sendDataGuaranteed",value:function(e,n,t){this.debugLog("--- mesh adapter send data guaranteed ---"),this.sendData(e,n,t),this.debugLog("--- mesh adapter send data guaranteed ---")}},{key:"broadcastData",value:function(e,n){this.debugLog("--- mesh adapter broadcast data ---"),this.channels.forEach(function(t){t.send(JSON.stringify(new c(e,n)))}),this.debugLog("--- mesh adapter broadcast data ---")}},{key:"broadcastDataGuaranteed",value:function(e,n){this.debugLog("--- mesh adapter broadcast data guaranteed ---"),this.broadcastData(e,n),this.debugLog("--- mesh adapter broadcast data guaranteed ---")}},{key:"offer",value:async function(e,n){var t=this,s=this.signalingServerUrl+"/"+n;this.signalingChannelOne.clients.has(e.signalingServerUrl)?await this.delayedSendOffer(e,s):this.signalingChannelOne.addServer(e.signalingServerUrl,this.email,this.secret,async function(n,i){await t.delayedSendOffer(e,s)})}},{key:"delayedSendOffer",value:async function(e,n){var t=this;"Sender"===t.debugLogPrefix?setTimeout(async function(){await t.sendOffer(e,n)},1e3):await t.sendOffer(e,n)}},{key:"sendOffer",value:async function(e,n){var t=n+" -> "+e.peerUrl,s=new RTCPeerConnection(this.configuration);this.connections.set(e.peerUrl,s);var i=e.peerUrl,o=s.createDataChannel(t);this.setupChannel(o,i),await this.signalingChannelOne.offer(e.signalingServerUrl,e.peerId,s),this.debugLog("mesh adapter sent offer to "+e.peerUrl)}},{key:"acceptOffer",value:function(e,n,t){var s=this,i=e+"/"+n,o=new RTCPeerConnection(this.configuration);return this.connections.set(i,o),this.debugLog("mesh adapter received offer from "+i),o.ondatachannel=function(e){var n=e.channel;s.setupChannel(n,i)},o}},{key:"setupChannel",value:function(e,n){var t=this;e.onopen=function(){t.channels.set(n,e),t.openListener(n),t.peers.set(n,!0),t.notifyOccupantsChanged(),t.debugLog("channel "+e.label+" opened")},e.onclose=function(){t.closeStreamConnection(n),t.peers.set(n,!1),t.notifyOccupantsChanged(),t.debugLog("channel "+e.label+" closed")},e.onmessage=function(s){t.debugLog("channel "+e.label+" received message "+s.data+" from "+n);var i=JSON.parse(s.data),o=n,r=i.dataType,a=i.data;t.messageListener(o,r,a)}}},{key:"notifyOccupantsChanged",value:function(){this.roomOccupantListener(Array.from(this.peers).reduce(function(e,n){var t=s(n,2),i=t[0],o=t[1];return Object.assign(e,function(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}({},i,o))},{}))}},{key:"debugLog",value:function(e){this.debugLogPrefix&&console.log(this.debugLogPrefix+" "+e)}}]),e}();"undefined"!=typeof NAF&&NAF.adapters.register("mesh",l),n.MeshAdapter=l},function(e,n,t){"use strict";t(3).MeshAdapter}]);